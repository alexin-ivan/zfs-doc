## DBUF

DBUF (DMU Buffer) - подсистема, отвечающая за чтение и запись данных в ARC (который, в свою очередь, либо от отдаёт кэшированое значение, либо перенаправляет вызовы в ZIO).
С этой подсистемой связано понятие "грязных" буферов (dirty buffers). Они содержат записи (dirty records), которые были изменены и нуждаются в сбросе на диск.
Кроме того, эта подсистема связана с механизмом транзакций - сброс данных на диск проходит в рамках транзакционной группы.

На рис. 10 представлена диаграмма состояний dbuf.

![Диаграмма состояний dbuf (10)](./img/zfs-dbuf-states.png  "Диаграмма состояний dbuf (10)")

Рассмотрим действия, при помощи которых происходит переход из одного состояния в другое (`enum dbuf_states`):

* $Alloc \rightarrow Uncached$ - получен запрос на выделение памяти для буфера;

* $Uncached \rightarrow Read$ - инициировано чтение данных, на которые ссылается некий blkptr.

* $Read \rightarrow Cached$ - данные были прочитаны с диска/кэша;

* $Uncached \rightarrow Fill$ - получен запрос на запись неких данных в dbuf;

* $Fill \rightarrow Cached$ - запрос на запись данных в dbuf завершён;

* $Uncached \rightarrow NotFill$ - оставить буфер пустым;

* $Cached \rightarrow Evict$ - очистка буфера;

* $NotFill \rightarrow Evict$ - очистка незаполненного буфера;

Заполнение `Fill` буфера производится в случае, если записываемые данные равны размеру буфера. В таком случае чтение данных с диска производиться не будет (TODO: уточнить).

`NotFill` в данный момент устанавливается в функции `dmu_buf_will_not_fill` (аналог `dmu_buf_will_fill`), которая вызывается в `dmu_prealloc`, которая
в свою очередь, раньше использовалась для обрабоки запросов `zvol_write`. В данный момент `dmu_prealloc` не используется в `zvol_write`, соответственно, буферы в состоянии
NotFill не используются.

"Изгнание" (`Evicting`) производится при вызове `dnode_evict_dbufs`. В этом случае из буфера удаляются данные,
указатель на данные (очищается blkptr), а сам буфер удаляется из хеш-таблицы dbuf'ов и из дерева dbuf'ов в `dnode`.


### Реализация COW-механизма в DBUF

TODO: в этом разделе будет разъяснён механизм "восходящего" (вверх по дереву косвенных блоков и вверх по дереву объектов)
записи данных. Но он будет добавлен после того, как будет закончен раздел по ZIO.
Также тут будет описание работы функции `dbuf_hold`.

### Статистика по DMU-буферам

DMU-буферы выделяются при помощи SLAB-аллокатора. Статистику по ним можно посмотреть в файле `/proc/slabinfo`:

```bash
# grep dmu_buf_impl_t /proc/slabinfo
name              <active_objs> <num_objs>  <objsize>  <objperslab>  <pagesperslab>
dmu_buf_impl_t    1819945       1834083     296        27            2             
# echo $((1819920 * 296)) # active_objs * objsize
538696320
```

Или в ARC-статистике:

```bash
#grep other_size /proc/spl/kstat/zfs/arcstats
other_size                      4    538965376
```

