## ARC

ARC (Adaptive Replacement Cache) - подсистема отвечающая за кеширование данных, проходящих между DMU и ZIO слоями.

Все запросы на запись/чтение проходят через эту подсистему.
Исключение составляют лишь метки и l2cache - операции с ними проходят напрямую через подсистему `ZIO`.

Рассмотрим основные элементы классической [`"ARC: A Self-Tuning, Low Overhead Replacement Cache" by N. Megiddo & D. Modha, FAST 2003`] реализации `ARC`:

* MRU Cache (Most recently used) - кэш, в который попадают блоки в порядке требования их. Хранит данные.

* MFU Cache (Most frequently used) - кэш, в который попадают блоки, которые требуют чаще всего. Хранит данные.

* Ghost MRU - кэш, в котором содержатся блоки, "изгранные" (вытесненные) из MRU. Хранит указатели на блоки.

* Ghost MFU - кэш, в котором содержатся блоки, "изгранные" (вытесненные) из MFU. Хранит указатели на блоки.

Таки образом, ARC позволяет с одной стороны ускорить работу при последовательном чтении блоков (за счёт `MRU`),
и ускорить работу при чтении случайных блоков (`MFU`) - с другой стороны.

Ghost-кэши используются для быстрого доступа к вытесненным из основного кэша данным.
То есть, имея указатель на блок в этом кэше, мы можем относительно быстро считать данные, на которые этот блок
указывает. Кроме того, при наличии кэша второго уровня (l2arc), представленного блочным устройством/устройствами с быстрым доступом (`SSD`),
мы также можем получить ускорение чтения данных за счёт механизма Ghost-кэшей.

### Особенности arc

arc считается кэшем на чтение. Однако, он может влиять и на операции записи:

1. При записи невыровненных блоков необходимо прочитать "старые" данные.

2. При записи блоки добавляются в ARC.



### Особенности l2arc

В качестве кэша второго уровня обычно используют SSD-диски.
Это позволяет ускорить чтение данных с пула.

К данным дискам предъявляются следующие требования/особенности:

* Высокая скорость чтения.

* Можно не беспокоиться об отказе устройства. Отказ устройства не повлияет на целостность данных пула.

* Скорость записи данных на устройство может быть низкой: запись происходит асинхронно, большими блоками по мере вытеснения данных из `RAM`.


### Особенности реализации ARC

Потребляемое ARC пространство (память) может быть разбито по типам элементов:

* ARC_SPACE_DATA

* ARC_SPACE_META

* ARC_SPACE_OTHER

* ARC_SPACE_HDRS

* ARC_SPACE_L2HDRS

При добавлении элементов этих типов увеличиваются соответствующие счётчики (`*_size*`),
а также увеличивается счётчик `arcstat_meta_used` при добавлении элементов, которые не относятся к типу `ARC_SPACE_DATA`.

